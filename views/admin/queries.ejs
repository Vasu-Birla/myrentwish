
<%- include ("header.ejs") %>
<%- include ("navbar.ejs") %>


<style>
  .conversation-container {
    max-height: 400px; /* Adjust as needed */
    overflow-y: auto; /* Enable vertical scrolling */
}

.customer-message {
    background-color: #10182a;
    color: white;
    padding: 10px;
    border-radius: 10px;
    margin-bottom: 10px;
    max-width: 100%;
    margin-right: 200px;
    margin-left: 10px;
}

.support-executive-message {
    background-color: #10182a;
    color: white;
    padding: 10px;
    border-radius: 10px;
    margin-bottom: 10px;
    max-width: 100%;
    align-self: flex-end;
    margin-left: 200px;
    margin-right: 10px;
   
}


.message-role1 {
    font-size: 14px;
    color: #888;
    margin-top: 5px;
}

.message-role {
    font-size: 11px;
    border-radius: 7px;
    text-transform: capitalize;
    color: #fff;
    padding: 0px 3px;
    border: 2px solid #4b4b4b;
    margin-top: 5px;
    background: #1c4526;
}

.msgtext {
  margin-top: 10px;
}

.closed-message {
    color: red;
    font-size: 16px;
    font-weight: bold;
    text-align: center;
    margin-top: 10px;
}

.badge.badge-info {
    background-color: #3abaf4;
    font-size: small;
}

.badge.badge-success {
    background-color: #54ca68;
    font-size: small;
}

.badge-warning {
    color: #212529;
    background-color: #be9109;
    font-size: small;
}

</style>


<!-- Modal -->
<div class="modal fade" id="emailModal" tabindex="-1" role="dialog" aria-labelledby="emailModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="emailModalLabel">Ticket Thread</h5>
 
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="closed-message">
      
      </div>
      

      <div class="modal-body">

       

        <form action="/admin/sendemail" method="post"> <!-- Adjust the form action URL as needed -->
          <div class="form-group">
            <label for="recipientEmail">Recipient Email:</label>
            <input type="email" class="form-control" id="recipientEmail" name="recipientEmail" value="" readonly>
          </div>

          <input type="hidden" class="form-control" id="ticket_number" name="ticket_number" value="" readonly>
          
          <div class="form-group">
            <label for="emailSubject">Subject:</label>
            <input type="text" class="form-control" id="emailSubject" name="emailSubject" required readonly>
          </div>
          <div class="form-group">
            <label for="emailMessage">Message:</label>
            <textarea class="form-control" id="emailMessage" name="emailMessage" rows="4" required></textarea>
          </div>
          <button type="submit" class="btn btn-success">Reply</button>
          <button type="button" class="btn btn-danger" data-dismiss="modal" onclick="closeEmailModal()">Close</button>
        </form>
      </div>
      <div class="conversation-container">
        <!-- Conversation messages will be displayed here -->
    </div>

    </div>
  </div>
</div>


      <!-- Main Content -->
      <div class="main-content">
        <section class="section">

          <div class="row">
            <div class="col-12">
              <div class="card">
                <div class="full-headings">
                  <h4> USER QUERIES MANAGEMENT </h4>
                </div>
                
             
              <% if (output && output.startsWith('Ticket Response')) { %>
                <div class="alert  alert-success">
                  <%= output %>
                </div> 
              <% } else if(output) { %>
                <div class="alert alert-danger">
                  <%= output %>
                </div>   
              <% } %>
              


              <!--  -->
              <div class="table-reponsive box">
                <div id="example_wrapper" class="dataTables_wrapper dt-bootstrap4 no-footer">
                  <div class="row">
                  <table id="example" class="table table-striped table-bordered dataTable no-footer" role="grid" aria-describedby="example_info">
                <thead>
                     <tr role="row">
                        <th class="sorting" tabindex="0" aria-controls="example" rowspan="1" colspan="1" aria-label="Day: activate to sort column ascending" style="width: 30.0781px;">Id</th>
                        <th class="sorting" tabindex="0" aria-controls="example" rowspan="1" colspan="1" aria-label="Day: activate to sort column ascending" style="width: 80.0781px;">Ticket Num  </th>
                        <th class="sorting" tabindex="0" aria-controls="example" rowspan="1" colspan="1" aria-label="Day: activate to sort column ascending" style="width: 80.0781px;">Customer </th>
                      <th class="sorting" tabindex="0" aria-controls="example" rowspan="1" colspan="1" aria-label="Day: activate to sort column ascending" style="width: 80.0781px;">Subject  </th>
                      <th class="sorting" tabindex="0" aria-controls="example" rowspan="1" colspan="1" aria-label="Dc Id: activate to sort column ascending" style="width: 167.953px;"> Message </th>
                      <th class="sorting" tabindex="0" aria-controls="example" rowspan="1" colspan="1" aria-label="Dc Id: activate to sort column ascending" style="width: 167.953px;"> Ticket Thread </th>                    
                      <th class="sorting" tabindex="0" aria-controls="example" rowspan="1" colspan="1" aria-label="Gross: activate to sort column ascending" style="width: 100.922px;">status</th>
                      <th class="sorting" tabindex="0" aria-controls="example" rowspan="1" colspan="1" aria-label="Action: activate to sort column ascending" style="width: 110.156px;">Action </th>
                    </tr>
                </thead>
                   <div class="table-responsive">
                      </div>
                      <tbody>

                        <% for(var i = 0; i < queries.length; i++) { %>
                      <tr>
                        <td><%- queries[i].id %></td>   
                        
                        <td>  <%- queries[i].complain_number %> </td>

                        <td>  <%- queries[i].customer_name %> </td>


                        <td>  <%- queries[i].subject %> </td>

                        <td>  <%- queries[i].message %> </td>

                        
                        <td> <button style=" background-color: rgb(255, 255, 255); color: rgb(12, 17, 59); font-weight: bold; " aria-pressed="true" data-toggle="modal" data-target="#emailModal" data-status="<%- queries[i].status %>"  data-subject="<%- queries[i].subject %>"  data-thread="<%= JSON.stringify(queries[i].ticket_thread) %>"  data-customer_name="<%- queries[i].customer_name %>" data-ticket="<%- queries[i].complain_number %>" data-email="<%- queries[i].email %>"> Open Thread </button> </td>

                  

                        <td>                      
                          
                         
                      <% if(queries[i].status == 'opened') { %>
                          <div class="badge badge-warning badge-lg"><%- queries[i].status %></div>
                          <% } else { %>                     
                            <div class="badge badge-success badge-lg"><%- queries[i].status %> </div>
                       
                       <% } %>  
                          
                          
                        </td>
                        <td>
                          

                       <% if(queries[i].status == 'opened') { %>
                          <button  onclick="updateStatus('<%= queries[i].id %>','<%= queries[i].status %>')" class="badge badge-info badge-lg"> Close Ticket  </button>
                          <% } else { %>                     
                            <div class="badge badge-success badge-lg"><%- queries[i].status %> By  <%- queries[i].closed_by %>  </div>
                       
                       <% } %> 
                 
                        
                        </td>
                    

                        
                      </tr>
                      <% } %>

                      </tbody>
                    </table>
                </div>
              </div>
          </div>
              <!--  -->
                </div>
              </div>
            </div>
          </div>
          </div>
        </section>

      </div>
      <footer class="main-footer">
        <div class="footer-left">
          Copyright by 
          <a href="https://www.myamberinnovations.com/"> Amber Innovations </a>
        </div>
        <div class="footer-right">
        </div>
      </footer>
    </div>
  </div>
  <!-- General JS Scripts -->
  <script src="../assets/js/app.min.js"></script>
  <!-- JS Libraies -->
  <script src="../assets/bundles/apexcharts/apexcharts.min.js"></script>
  <!-- Page Specific JS File -->
  <script src="../assets/js/page/index.js"></script>
  <!-- Template JS File -->
  <script src="../assets/js/scripts.js"></script>
  <!-- Custom JS File -->
  <script src="../assets/js/custom.js"></script>
  <!-- DATA TABLES SCRIPT START -->
    <!-- All PAGE DATA TABLEC SCRIPT START All PAGE DATA TABLEC SCRIPT START -->
<!-- <script src="https://code.jquery.com/jquery-3.3.1.js"></script> -->
<script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.19/js/dataTables.bootstrap4.min.js"></script>
<script>
$(document).ready(function() {
    $('#example').DataTable();
} );
</script>

</body>


<!-- index  21 Nov 2019 03:47:04 GMT -->
</html>


<script>
  $(document).ready(function() {
      $('#example').DataTable();
  } );
  
  
  
  function updateStatus(id,status)
  { 
  
   
     $.ajax({
  
                  url: "/admin/queries",
                  type: "POST",
                  data:{ id : id , status:status},
                  dataType: 'json',
                      success: function(result) { 
                        window.location.href = '/admin/queries'; 
                  }
                  }
              )
  }
  
  $('#emailModal').on('show.bs.modal', function (event) {
      var button = $(event.relatedTarget); // Button that triggered the modal


      var recipientEmail = button.data('email'); 
      var ticket_number = button.data('ticket'); 
      var ticket_thread = button.data('thread')
      var customer_name = button.data('customer_name')
      var subject = button.data('subject')
      var status = button.data('status')
      

      var uniqueSubject = 'Ticket_'+ticket_number+'_'+subject

        console.log(ticket_thread)
      var modal = $(this);

      if(status=='opened'){
        
          // Populate the recipient email field
      modal.find('#recipientEmail').val(recipientEmail);
      modal.find('#ticket_number').val(ticket_number);
      modal.find('#emailSubject').val(uniqueSubject);

       // Show the modal body
       modal.find('.modal-body').show();
        modal.find('.closed-message').hide();


      }else{

 
          modal.find('.modal-body').hide();
        modal.find('.closed-message').show().text('This Ticket is closed');

      }
  
    


      
      var conversationContainer = modal.find('.conversation-container');
        conversationContainer.empty();

      //  ticket_thread.reverse();

// Display conversation messages
ticket_thread.forEach(function(message) {

  
    var messageHtml = '<div class="message"  >';
    if (message.role === 'customer') {
        messageHtml += '<div class="customer-message" style="text-align:left" >';
          //messageHtml += '<span class="message-role"> Customer </span>'; 
          messageHtml += '<span class="message-role">' + customer_name +' :' + '</span>'; 
    } else {
        messageHtml += '<div class="support-executive-message" style="text-align:right">';
          // messageHtml += '<span class="message-role">' + message.role+' :' + '</span>'; 
          messageHtml += '<span class="message-role"> Support Executive </span>'; 
    }

    messageHtml += '<p class="msgtext">' + message.message + '</p>';
    messageHtml += '<span class="message-role">' + formatTime(message.timestamp) + '</span>';
    messageHtml += '</div>'; // Close message container   
    messageHtml += '</div>'; // Close message
    conversationContainer.append(messageHtml);
});

// Function to format timestamp
function formatTime(timestamp) {
    var time = new Date(timestamp);
    var hours = time.getHours();
    var minutes = time.getMinutes();
    var ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12;
    hours = hours ? hours : 12; // Handle midnight (0 hours)
    minutes = minutes < 10 ? '0' + minutes : minutes; // Add leading zero to minutes if needed
    var formattedTime = hours + ':' + minutes + ' ' + ampm;
    return formattedTime;
}


    });
  


   
  function closeEmailModal() {
    window.location.href = '/admin/queries'; 
  }

  </script>